- name: Sync Repo
  run: |
    export REPO_ALLOW_ANY_PYTHON=1 # На всякий случай для совместимости
    repo init -u ... --no-clone-bundle
    repo sync -c -j$(nproc) --no-tags --no-clone-bundle
  env:
    REPO_AUTOUPDATE: "0"


name: Build TWRP Recovery
on:
  workflow_dispatch:
    inputs:
      MANIFEST_BRANCH:
        description: 'TWRP Manifest Branch'
        required: true
        default: 'twrp-12.1'
        type: choice
        options:
          - twrp-12.1
          - twrp-13.0
          - twrp-14.1
      BUILD_TARGET:
        description: 'Build Target'
        required: true
        default: 'recovery'
        type: choice
        options:
          - recovery
          - boot

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 480
    
    steps:
    - name: Checkout Device Tree
      uses: actions/checkout@v4
      with:
        path: device/samsung/m13
    
    - name: Free Disk Space
      uses: jlumbroso/free-disk-space@main
      with:
        android: true
        tool-cache: false
    
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          bc bison build-essential ccache curl flex g++-multilib \
          gcc-multilib git git-lfs gnupg gperf imagemagick lib32ncurses5-dev \
          lib32readline-dev lib32z1-dev liblz4-tool libncurses5 libncurses5-dev \
          libsdl1.2-dev libssl-dev libxml2 libxml2-utils lzop \
          pngcrush rsync schedtool squashfs-tools xsltproc zip zlib1g-dev \
          python3 python-is-python3 repo libncurses6
    
    - name: Add Swap (4GB)
      run: |
        sudo fallocate -l 4G /swapfile
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        free -h
    
    - name: Initialize TWRP Directory
      run: |
        mkdir -p twrp
      timeout-minutes: 5
    
    - name: Configure Git
      run: |
        cd twrp
        git config --global user.email "actions@github.com"
        git config --global user.name "GitHub Actions"
      timeout-minutes: 5
    
    - name: Repo Init
      run: |
        cd twrp
        repo init --depth=1 --no-clone-bundle --repo-rev=stable -u https://github.com/minimal-manifest-twrp/platform_manifest_twrp_aosp.git -b ${{ inputs.MANIFEST_BRANCH }}
      timeout-minutes: 30
    
    - name: Repo Sync
      run: |
        cd twrp
        repo sync -c --no-tags -j$(nproc --all)
      timeout-minutes: 480
    
    - name: Copy Device Tree
      run: |
        cp -r device/samsung/m13 twrp/device/samsung/
        cp ../AndroidProducts.mk twrp/
    
    - name: Build
      run: |
        cd twrp
        export ALLOW_MISSING_DEPENDENCIES=true
        export USE_CCACHE=1
        source build/envsetup.sh
        lunch twrp_m13-ap2a-eng
        make recoveryimage -j2  # Ограничьте ядра!
