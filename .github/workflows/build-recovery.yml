name: Build TWRP Recovery
on:
  workflow_dispatch:
    inputs:
      MANIFEST_BRANCH:
        description: 'TWRP Manifest Branch'
        required: true
        default: 'twrp-12.1'
        type: choice
        options:
          - twrp-12.1
          - twrp-13.0
          - twrp-14.1
      BUILD_TARGET:
        description: 'Build Target'
        required: true
        default: 'recovery'
        type: choice
        options:
          - recovery
          - boot

jobs:
  build:
    runs-on: ubuntu-22.04  # БОЛЬШЕ памяти!
    timeout-minutes: 180  # Увеличьте!
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        path: device/samsung/m13
        
    - name: Free disk space
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: false
        
    - name: Build TWRP
      uses: docker://mrkev/twrp-builder:latest  # Готовый образ
      with:
        device: samsung/m13
        branch: ${{ inputs.MANIFEST_BRANCH }}
        recovery: ${{ inputs.BUILD_TARGET == 'recovery' }}
        threads: 2  # Важно для памяти
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: twrp-img
        path: |
          out/target/product/*/recovery.img
          out/target/product/*/boot.img
